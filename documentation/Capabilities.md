# Пакет capabilities

Пакет **`capabilities`** отвечает за тонкую настройку и инициализацию конкретных экземпляров браузеров (Chrome, Firefox,
Edge).
Здесь реализована логика преобразования конфигурации (`BrowserConfig`) в нативные объекты Selenium (`Options`),
управление драйверами через `WebDriverManager` и поддержка специфических функций (headless, расширения, профили).

Архитектура пакета построена на наследовании для переиспользования кода между похожими браузерами (семейство Chromium).

---

## 1. Класс `SeleniumBrowserCapabilities`

Диспетчер, управляющий выбором нужной фабрики.
Он не создает драйвер сам, а делегирует эту задачу соответствующей реализации `BrowserDriverFactory`.

### Поля класса

| Поле           | Описание                                                                                                                                                                             |
|:---------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`registry`** | `Map<String, BrowserDriverFactory>`<br>Реестр всех доступных фабрик браузеров. Заполняется автоматически через **SPI** (`ServiceLoader`). Ключ — имя браузера ("chrome", "firefox"). |

### Методы

| Метод              | Логика работы                                                                                                                                                                                                                                                                                                                                                         |
|:-------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`createDriver`** | **Точка входа.**<br>1. Считывает имя желаемого браузера из `runtime.yaml` (параметр `browser`).<br>2. Ищет соответствующую фабрику в `registry`. Если не находит — падает с ошибкой.<br>3. Загружает детальный конфиг браузера (например, `chrome.yaml`) через `RuntimeReader`.<br>4. Вызывает метод `factory.createDriver(config)` и возвращает готовый `WebDriver`. |

---

## 2. Класс `AbstractBrowserDriverFactory`

Базовый абстрактный класс для всех фабрик Selenium.
Наследуется от `BaseBrowserFactory` (из `core_lib`) и добавляет специфичную для Selenium логику.

### Методы (Protected)

Эти методы используются наследниками для устранения дублирования кода.

| Метод                       | Описание и Логика                                                                                                                                                                                                                                                                                                                                                                          |
|:----------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`setupDriverBinary`**     | **Управление бинарником драйвера (chromedriver/geckodriver).**<br>Реализует систему приоритетов:<br>1. **Локальный файл:** Ищет драйвер в `configuration_files/browsers_drivers/`. Если найден — устанавливает `System.setProperty`.<br>2. **WDM Версия:** Если указана `driverVersion`, скачивает её через `WebDriverManager`.<br>3. **WDM Авто:** Скачивает последнюю версию (`LATEST`). |
| **`applyWindowSettings`**   | Применяет настройки окна к уже созданному драйверу.<br>Поддерживает: `maximize`, `fullscreen`, `size:WxH` (парсинг размера наследуется от `BaseBrowserFactory`).                                                                                                                                                                                                                           |
| **`getPageLoadStrategy`**   | Конвертирует строковую настройку (`normal`, `eager`, `none`) в Enum `PageLoadStrategy`.                                                                                                                                                                                                                                                                                                    |
| **`logBrowserInformation`** | Извлекает из запущенного драйвера реальное имя и версию браузера (`Capabilities`) и пишет их в лог. Полезно для отладки на CI.                                                                                                                                                                                                                                                             |

---

## 3. Класс `AbstractChromiumFactory`

Промежуточный абстрактный слой для семейства браузеров на движке **Chromium** (Chrome, Edge, Opera, Yandex).
Позволяет настроить общие для них параметры (аргументы запуска, headless) в одном месте.

### Методы

| Метод                        | Описание                                                                                                                                                                                                                                                                                                             |
|:-----------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`configureCommonOptions`** | Принимает объект `ChromiumOptions` (родитель ChromeOptions/EdgeOptions).<br>1. Устанавливает путь к бинарнику браузера (`setBinary`), если задан.<br>2. Включает Headless режим (`--headless=new`).<br>3. Добавляет пользовательские аргументы (`args`) из конфига.<br>4. Устанавливает стратегию загрузки страницы. |

---

## 4. Класс `ChromeBrowserDriverFactory`

Фабрика для Google Chrome. Наследуется от `AbstractChromiumFactory`.

### Метод `createDriver`

**Алгоритм:**

1. Настраивает драйвер (`chromedriver`) через `setupDriverBinary`.
2. Создает `ChromeOptions`.
3. Настраивает опции через родительский метод `configureCommonOptions`.
4. Инициализирует `new ChromeDriver(options)`.
5. Применяет настройки окна.
6. Логирует версию.
7. Возвращает драйвер.

---

## 5. Класс `EdgeBrowserDriverFactory`

Фабрика для Microsoft Edge. Наследуется от `AbstractChromiumFactory`.
Логика идентична Chrome, но используются классы `EdgeDriver`, `EdgeOptions` и менеджер `edgedriver`.

---

## 6. Класс `FirefoxBrowserDriverFactory`

Фабрика для Mozilla Firefox. Наследуется напрямую от `AbstractBrowserDriverFactory` (так как у Firefox свой движок
Gecko).

### Особенности реализации

В отличие от Chromium, Firefox имеет специфичный механизм настройки через профиль (`FirefoxProfile` / `Preferences`).

### Метод `createDriver`

**Алгоритм:**

1. Настраивает `geckodriver` через WDM.
2. Создает `FirefoxOptions`.
3. Настраивает бинарник и headless (аргумент `-headless`).
4. **Парсинг Preferences:**
    * Iterрует по списку строк `preferences` из конфига.
    * Вызывает приватный метод `applyPreference`, который разделяет строку по знаку `=` и автоматически определяет тип
      значения (Boolean/Integer/String).
    * Применяет настройку через `options.addPreference()`.
5. Инициализирует `new FirefoxDriver(options)`.